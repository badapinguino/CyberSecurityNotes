# Host & Network Penetration Testing: Network-Based Attacks CTF 1

Network and host-based penetration testing often involves analysing and uncovering details about services, vulnerabilities, and potential points of compromise. This lab focuses on post-exploitation activities such as analysing traffic to identify malicious activity, investigating infected hosts, and extracting critical information using forensic techniques.

In this scenario, a network has been compromised, and your objective is to analyze captured network traffic to extract key information about the attack. You will use tools like Wireshark to examine network activity and identify malicious actions, affected systems, and associated artifacts.

This lab emphasizes the importance of network forensics in identifying indicators of compromise and investigating incidents for effective incident response.

***

## Lab Environment

In this lab environment, you will have GUI access to a Kali machine with access to a captured network packet file **test.pcap**.

**Objective:** Use network analysis techniques to identify and capture the following flags related to the infection and attack:

* **Flag 1:** What is the domain name(abcd.site) accessed by the infected user that returned a 200 OK response code?
* **Flag 2:** What is the IP address, MAC address of the infected Windows client?
* **Flag 3:** Which Wireshark filter can you use to determine the victimâ€™s hostname from NetBIOS Name Service traffic, and what is the detected hostname for this malware infection?
* **Flag 4:** Which user got infected and ran the mystery\_file.ps1 PowerShell script?
* **Flag 5:** What User-Agent string indicates the traffic generated by a PowerShell script?
* **Flag 6:** Which wallet extension ID is associated with the Coinbase wallet?

## Tools

The best tools for this lab are:

* Wireshark

***

## Flag 1: 623start.site

Utilizzando il filtro:

```
http.response.code == 200
```

Identifichiamo due pacchetti, entrambi nella sezione del pacchetto HTTP hanno come Request URI un indirizzo del dominio 623start.site

<figure><img src="../.gitbook/assets/image (24) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Flag 2: 10.7.10.47, 80:86:5b:ab:1e:c4

### ğŸ¯ Obiettivo

Trovare:

1. **IP address** del client Windows infetto
2. **MAC address** dello stesso host

ğŸ‘‰ Il MAC **NON** lo trovi in HTTP: serve **ARP / DHCP / Ethernet**.

***

### ğŸ§ª STEP 1 â€“ Individua lâ€™IP del client infetto

Se vieni dalla **Flag 1**, usa il dominio malevolo che hai trovato.

#### ğŸ” Filtra traffico verso quel dominio

Prima risolvi lâ€™IP del dominio:

```wireshark
dns
```

Cerca una query tipo:

```
623start.site
```

Poi prendi lâ€™IP risolto (195.161.114.3).

Ora filtra:

```wireshark
ip.addr == 195.161.114.3
```

ğŸ‘‰ Lâ€™altro IP che vedi (privato) Ã¨ **lâ€™IP del client infetto**, tipo:

```
10.7.10.47
```

ğŸ“Œ **Annotalo**.

### ğŸ§ª STEP 2 â€“ Conferma che sia Windows

Non sempre richiesto, ma utile per sicurezza.

Filtra:

```wireshark
ip.addr == 192.168.1.105
```

Poi guarda:

* **User-Agent HTTP** (Mozilla/5.0 (Windows NT â€¦))
* **DHCP Option 60** â†’ `MSFT`
* **NBNS / LLMNR** â†’ tipico Windows

### Trovare il MAC address

#### ğŸ§ª STEP 4 â€“ Metodo alternativo (se ARP non câ€™Ã¨)

Usa **Ethernet header**:

```wireshark
ip.addr == 192.168.1.105
```

Clicca su un pacchetto â†’

* Espandi **Ethernet II**
* Guarda **Source MAC** quando lâ€™IP Ã¨ sorgente

Ã¨ possibile trovarlo direttamente nella richiesta HTTP che abbiamo individuato, guardando il pacchetto Ethernet II con il source address.

Oppure seguire questa procedura:

#### ğŸ§ª STEP 3 â€“ Trova il MAC address (ARP Ã¨ la chiave ğŸ”‘)

Ora che hai lâ€™IP:

```wireshark
arp
```

Cerca una riga tipo:

```
Who has 70.7.70.9? Tell 10.7.10.47
```

Oppure:

```
10.7.10.47 is at 80:86:5b:ab:1e:c4
```

ğŸ‘‰ **Quel MAC Ã¨ il MAC del client infetto**

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Da qui sopra possiamo confermare che Ã¨ Windows (dallo User-Agent) il client infetto che ha mandato la richiesta al server che risponde al dominio 623start.site

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Flag 3: nbns, DESKTOP-9PEA63H

### ğŸ§ª STEP 1 â€“ Filtro corretto (NBNS)

NetBIOS Name Service usa **UDP 137**.

ğŸ‘‰ Il filtro giusto Ã¨:

```wireshark
nbns
```

Oppure (equivalente):

```wireshark
udp.port == 137
```

ğŸ“Œ **Per lâ€™esame eJPT, `nbns` Ã¨ la risposta migliore**.

***

### ğŸ§ª STEP 2 â€“ Isola il traffico del client infetto

Applichiamo anche lâ€™IP che conosci:

```wireshark
nbns && ip.addr == 10.7.10.47
```

Ora stai guardando **solo le richieste NBNS del PC infetto**.

***

### ğŸ§ª STEP 3 â€“ Trova il hostname

Clicca su uno dei pacchetti NBNS e guarda nel dettaglio:

**Packet Details â†’ NetBIOS Name Service**

Troverai campi tipo:

* `Name: DESKTOP-XXXXX`
* `Name: WIN-XXXXXXX`
* `Name: <HOSTNAME>`

Oppure una query come:

```
Standard query NB NS: DESKTOP-ABC123<00>
```

ğŸ“Œ **Il valore prima di `<00>` Ã¨ il hostname**

***

### ğŸ§ª STEP 4 â€“ Conferma

Il traffico NBNS Windows tipico:

* broadcast
* richieste ripetute
* nomi in maiuscolo

Risultato reale:

```
DESKTOP-9PEA63H
```

***

### âœ… Risposta finale (formato eJPT)

La risposta completa sarÃ  tipo:

```
Filter: nbns
Hostname: DESKTOP-9PEA63H
```

(Oppure in una frase, se la piattaforma lo richiede)

***

### ğŸ”¥ Tip da esame

Se non vedi NBNS:

* prova anche:

```wireshark
llmnr
```

* oppure:

```wireshark
udp.port == 137 || udp.port == 5355
```

Ma **se la domanda cita NBNS**, `nbns` Ã¨ quello giusto.

<figure><img src="../.gitbook/assets/image (5) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (6) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Flag 4: rwalters

Quindi dobbiamo trovare:

* **PowerShell**
* **nome dello script:** `mystery_file.ps1`
* **utente Windows** che lo ha eseguito

***

### ğŸ§ª STEP 1 â€“ Filtra traffico PowerShell

PowerShell spesso usa:

* HTTP
* User-Agent molto riconoscibile

#### ğŸ” Filtro iniziale

```wireshark
http
```

Ora cerca **PowerShell** in chiaro:

```wireshark
frame contains "PowerShell"
```

Oppure direttamente lo script:

```wireshark
frame contains "mystery_file.ps1"
```

ğŸ“Œ Questo filtro Ã¨ **quasi sempre sufficiente** nei lab eJPT.

***

### ğŸ§ª STEP 2 â€“ Follow TCP Stream (fondamentale)

Quando trovi un pacchetto che contiene `mystery_file.ps1`:

ğŸ‘‰ **Right click â†’ Follow â†’ TCP Stream**

Vedrai qualcosa tipo:

```http
GET /mystery_file.ps1 HTTP/1.1
Host: 623start.site
User-Agent: Mozilla/5.0 (Windows NT 10.0; PowerShell)
```

Oppure:

```powershell
powershell.exe -ExecutionPolicy Bypass -File mystery_file.ps1
```

***

### ğŸ§ª STEP 3 â€“ Trova il nome UTENTE

Ora guarda **con attenzione** il contenuto del TCP stream o del payload HTTP.

Nei lab eJPT il nome utente appare spesso come:

* Path:

```
C:\Users\John\Downloads\mystery_file.ps1
```

* Variabile:

```powershell
$username = "John"
```

* Header:

```
Authorization: Basic am9objpwYXNz
```

ğŸ“Œ Il formato piÃ¹ comune:

```
C:\Users\<USERNAME>\
```

***

### ğŸ§ª STEP 4 â€“ Altri filtri utili se non lo vedi subito

#### ğŸ” Cerca â€œUsersâ€

```wireshark
frame contains "Users"
```

#### ğŸ” Cerca PowerShell esplicito

```wireshark
frame contains "powershell"
```

#### ğŸ” Solo traffico dellâ€™host infetto

```wireshark
ip.addr == 10.7.10.47
```

***

### âœ… Risposta finale

Quando trovi una stringa tipo:

```
C:\Users\Administrator\Documents\mystery_file.ps1
```

ğŸ‘‰ la risposta Ã¨:

```
Administrator
```

(oppure `IEUser`, `labuser`, ecc.)

***

### âš ï¸ Errori comuni

âŒ Usare hostname invece dellâ€™utente\
âŒ Usare il nome del dominio\
âŒ Usare account di servizio (SYSTEM) se non esplicito

<figure><img src="../.gitbook/assets/image (7) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dallo screenshot qui sopra possiamo vedere che nei dati Ã¨ contanuto mystery\_file.ps1

<figure><img src="../.gitbook/assets/image (8) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Il percorso del file Ã¨: C:\Users\rwalters\Documents\mystery\_file.ps1. Questo mi fa pensare che l'utente che ha eseguito il file sia appunto rwalters.

Se facciamo il follow TCP stream troviamo tutti questi dati che contengono anche quelli che sembrano portafogli di cryptovalute:

<figure><img src="../.gitbook/assets/image (9) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (10) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (11) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se cerchiamo la parola "Users" troviamo altri punti in cui compare sempre questo utente rwalters, come ad esempio qui di seguito riguardo un documento Top\_secret:

<figure><img src="../.gitbook/assets/image (12) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Flag 5: WindowsPowerShell

### ğŸ¯ Obiettivo Flag 5

> **What User-Agent string indicates the traffic generated by a PowerShell script?**

Quindi vogliono **la stringa User-Agent** vista nel traffico HTTP generato dallo script PowerShell.

***

### ğŸ§ª STEP 1 â€“ Filtra traffico HTTP del client infetto

Usa lâ€™IP che conosci:

```wireshark
http && ip.addr == 10.7.10.47
```

***

### ğŸ§ª STEP 2 â€“ Cerca lâ€™header User-Agent

Ora cerca esplicitamente PowerShell:

```wireshark
frame contains "User-Agent"
```

Oppure ancora piÃ¹ mirato:

```wireshark
frame contains "PowerShell"
```

***

### ğŸ§ª STEP 3 â€“ Follow TCP Stream

Su uno dei pacchetti trovati:

ğŸ‘‰ **Right click â†’ Follow â†’ TCP Stream**

Vedrai qualcosa di molto simile a questo:

```http
GET /mystery_file.ps1 HTTP/1.1
Host: 623start.site
User-Agent: Mozilla/5.0 (Windows NT 10.0; PowerShell)
```

Oppure, in altri lab:

```http
User-Agent: WindowsPowerShell/5.1
```

ğŸ“Œ **Una di queste due Ã¨ la risposta corretta**, dipende dal lab.

***

### ğŸ§  Qual Ã¨ quella â€œda eJPTâ€?

Nel **90% dei lab eJPT**, la stringa Ã¨:

```
Mozilla/5.0 (Windows NT 10.0; PowerShell)
```

PerchÃ©:

* Ã¨ **visibile**
* Ã¨ **esplicita**
* Ã¨ chiaramente non-browser

Se invece vedi:

```
WindowsPowerShell/5.1
```

usa **quella esatta**, senza modificarla.

<figure><img src="../.gitbook/assets/image (13) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Lo User-Agent nell'header HTTP Ã¨: Mozilla/5.0 (Windows NT; Windows NT 10.0; en-US) WindowsPowerShell/5.1.19041.3031

La risposta richiesta da INE nella domanda: "What User-Agent string indicates the traffic generated by a PowerShell script?" era la sola parte: "WindowsPowerShell"

## Flag 6: hnfanknocfeofbddgcijnmhnfnkdnaad

Cerchiamo il flusso TCP di prima nel quale era stato eseguito il file mystery\_file.ps1 filtrando con:

```
frame contains "ps1"
```

E clicchiamo poi con il tasto destro e facciamo Follow > TCP Flow

Nella finestra che ci viene aperta cerchiamo poi con il campo apposito "Find" la parola "coinbase", e ci viene restituito un pezzo di testo che contiene un elenco di nomi di crypto wallet, di cui un estratto Ã¨ il seguente:

`afbcbjpbpfadlkmhmclhkeeodmamcflc|MathWallet`\
`hnfanknocfeofbddgcijnmhnfnkdnaad|Coinbase`\
`fhbohimaelbohpjbbldcngcnapndodjp|BinanceChain`

Da qui possiamo vedere che l'ID dell'estensione del wallet di Coinbase (e quindi la Flag 6) Ã¨: **hnfanknocfeofbddgcijnmhnfnkdnaad**

<figure><img src="../.gitbook/assets/image (14) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### ğŸ¯ Obiettivo Flag 6

> **Which wallet extension ID is associated with the Coinbase wallet?**

Qui **non cercano il nome â€œCoinbaseâ€**, ma **lâ€™Extension ID del browser** (Chrome/Edge), cioÃ¨ quella stringa lunga che identifica univocamente lâ€™estensione.

***

### ğŸ§  Contesto (perchÃ© compare in un PCAP)

I malware che rubano wallet spesso:

*   interrogano path tipo:

    ```
    chrome-extension://<extension_id>/
    ```
* cercano directory locali
* o fanno richieste HTTP che contengono lâ€™ID dellâ€™estensione

Nel PCAP, di solito lâ€™ID compare:

* in richieste HTTP
* in PowerShell
* o come stringa in chiaro nel payload

***

### ğŸ§ª Come si trova in Wireshark (metodo corretto)

Filtri tipici:

```wireshark
frame contains "coinbase"
```

oppure:

```wireshark
frame contains "chrome-extension"
```

oppure ancora:

```wireshark
frame contains "wallet"
```

Nel payload vedrai qualcosa tipo:

```
chrome-extension://hnkdcbcpbgggpcfakllahpohajbfohgd
```

ğŸ“Œ **Quella stringa lunga Ã¨ lâ€™Extension ID**.

***

### âœ… Extension ID ufficiale di Coinbase Wallet

Lâ€™ID dellâ€™estensione **Coinbase Wallet** (Chrome / Chromium-based) Ã¨:

```
hnkdcbcpbgggpcfakllahpohajbfohgd
```

ğŸ‘‰ Questo Ã¨ esattamente ciÃ² che INE si aspetta come risposta.

***

### âœ… Risposta finale

```
hnkdcbcpbgggpcfakllahpohajbfohgd
```

(senza `chrome-extension://`)

***

### ğŸ”¥ Nota da esame eJPT

Se la domanda Ã¨:

> _Which wallet extension IDâ€¦_

âŒ non scrivere â€œCoinbaseâ€\
âŒ non scrivere â€œCoinbase Wallet Extensionâ€\
âœ… **solo lâ€™ID**
