# Vulnerability Analysis: BlueKeep (CVE-2019-0708) - RDP

<figure><img src="../.gitbook/assets/image (651).png" alt=""><figcaption></figcaption></figure>

Modificare ed eseguire codice al kernel level è probabile risulti in crash del sistema.

<figure><img src="../.gitbook/assets/image (652).png" alt=""><figcaption></figcaption></figure>

Deve essere abilitato RDP e disabilitata la Network Level authentication. E quindi per mitigare si può abilitare la Network Level Authentication.

<figure><img src="../.gitbook/assets/image (653).png" alt=""><figcaption></figcaption></figure>

Meglio usare il modulo exploit di MSF, perché molti exploit online possono contenere codice malevolo perché non ne è mai uscito uno ufficiale dato che lo ha scoperto Microsoft.

Il laboratorio di test usato usa una Windows 7 SP 1 vulnerabile.

## Esecuzione dell'exploit con modulo di Metasploit Framework

### Avvio MSF e ricerca dei due moduli BlueKeep (per test e per exploit)

```
sudo nmap -p 3389 10.10.10.7
msfconsole
search BlueKeep
```

<figure><img src="../.gitbook/assets/image (654).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (655).png" alt=""><figcaption></figcaption></figure>

### Test se target è vulnerabile a BlueKeep

```
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
set RHOSTS 10.10.10.7
run
```

<figure><img src="../.gitbook/assets/image (656).png" alt=""><figcaption></figcaption></figure>

Possiamo cambiare la RPORT se la porta su cui gira RDP non è quella di default.

<figure><img src="../.gitbook/assets/image (657).png" alt=""><figcaption></figcaption></figure>

Il target è vulnerabile.

### Exploit target vulnerabile a BlueKeep

```
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
show options
set RHOSTS 10.10.10.7
show targets
set target 2
```

è uno staged payload, e funziona solo su Windows a 64 bit.

<figure><img src="../.gitbook/assets/image (658).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../.gitbook/assets/image (659).png" alt=""><figcaption></figcaption></figure>

Fallisce perché questo exploit ci obbliga a impostare la versione di Windows del target manualmente.

<figure><img src="../.gitbook/assets/image (660).png" alt=""><figcaption></figcaption></figure>

Nel nostro caso il target è un Windows 7 SP1 build 7601 x64 su Virtualbox. Quindi impostiamo il numero 2.

<figure><img src="../.gitbook/assets/image (661).png" alt=""><figcaption></figcaption></figure>

Ora aspettiamo di capire se sta funzionando, ha settato la dimensione del CHUNK grooming strategy (groom size) a 250MB, ma questo dipende dalla RAM allocata per la macchina target. Se questo valore è troppo alto può causare il crash della macchina target.

In casi reali in cui abbiamo come target un sistema di una azienda bisogna assolutamente fare attenzione ad avviare degli exploit che sfruttano il kernel. Perché possono causare crash e perdite di memoria.

<figure><img src="../.gitbook/assets/image (662).png" alt=""><figcaption></figcaption></figure>

A quanto pare siamo stati fortunati ed è andato l'exploit al primo tentativo.

Ha inviato lo stage al target e ha aperto una meterpreter shell.
