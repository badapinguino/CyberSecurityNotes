# Windows Kernel Exploits

<figure><img src="../../.gitbook/assets/image (798).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (799).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (800).png" alt=""><figcaption></figcaption></figure>

In generale se possibile meglio evitare fare privilege escalation tramite kernel perché può causare instabilità e arresto dell'ambiente o perdita di dati. Da non usare in un ambiente enterprise.

<figure><img src="../../.gitbook/assets/image (801).png" alt=""><figcaption></figcaption></figure>

## Privilege Escalation automatica con MSF

Partiamo con i nostri esempi di laboratorio dal caso in cui abbiamo una meterpreter shell con accesso tramite utente non privilegiato

<figure><img src="../../.gitbook/assets/image (803).png" alt=""><figcaption></figcaption></figure>

## Come identificare le vulnerabilità kernel con metasploit

C'è un comando nella shell meterpreter che permette di elevare i privilegi in maniera automatica tentando di utilizzare diverse tecniche. Il comando è **getsystem.**

<figure><img src="../../.gitbook/assets/image (805).png" alt=""><figcaption></figcaption></figure>

In questo caso tutte le tecniche sono fallite, ma per ora mettiamo la sessione in background un attimo.

### Modulo MSF per suggerire exploit

<figure><img src="../../.gitbook/assets/image (806).png" alt=""><figcaption></figcaption></figure>

è un modulo MSF per la post exploitation.

```
search suggester
use post/multi/recon/local_exploit_suggester
show options
sessions
set SESSION 3 //essendo un modulo per post exploitation inserire la sessione attiva da usare
run
```

<figure><img src="../../.gitbook/assets/image (807).png" alt=""><figcaption></figcaption></figure>

Avviandolo ci mostra tutte le vulnerabilità presenti in questa versione di windows, e mostrerà poi i moduli MSF per poter elevare i privilegi.

<figure><img src="../../.gitbook/assets/image (808).png" alt=""><figcaption></figcaption></figure>

Ci elenca tutti i moduli che si possono usare per tentare di elevare i privilegi.

Questi moduli possono essere usati dopo aver fatto una ricerca di quali versioni di windows sono vulnerabili e se la nostra del target è tra quelle.

Ad esempio prendiamo la seguente vulnerabilità MS10 092 schelevator:

<figure><img src="../../.gitbook/assets/image (809).png" alt=""><figcaption></figcaption></figure>

E cerchiamo su google:

<figure><img src="../../.gitbook/assets/image (810).png" alt=""><figcaption></figcaption></figure>

E apriamo il link di rapid7, che è la compagnia che ha comprato metasploit framework:

<figure><img src="../../.gitbook/assets/image (811).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (812).png" alt=""><figcaption></figcaption></figure>

Questo però non è un kernel exploit leggendo la descrizione. Quindi prendiamo il risultato successivo di local\_exploit\_suggester:

<figure><img src="../../.gitbook/assets/image (813).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (814).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (815).png" alt=""><figcaption></figcaption></figure>

Questo fa uso del subsystem e quindi capiamo che si tratta di kernel exploit, ed è compatibile per le versioni di Windows 7 SP0 e SP1.

&#x20;Proviamo quindi ad usarlo

### Utilizziamo uno dei moduli exploit suggeriti per fare privesc automatica con MSF

```
use exploit/windows/local/ms16_014_wmi_recv_notif
set SESSION 3
set LPORT 4422 //in questo caso perché c'era una sessione attiva sulla porta 4444 preimpostata da MSF
exploit
```

<figure><img src="../../.gitbook/assets/image (816).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (817).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (818).png" alt=""><figcaption></figcaption></figure>

## Privilege escalation manuale

<figure><img src="../../.gitbook/assets/image (819).png" alt=""><figcaption></figcaption></figure>

Passiamo alla sessione 3 per poter fare la privesc manuale

<figure><img src="../../.gitbook/assets/image (820).png" alt=""><figcaption></figcaption></figure>

Iniziamo ad esplorare i tool elencati nelle slide per fare privesc manuale

### Privesc con Windows Exploit Suggester

1. Clonare Windows-Exploit-Suggester sul proprio ambiente
2. Aggiornare il db con **./windows-exploit-suggester.py --update**
3. Eseguire un comando systeminfo sul sistem target a cui abbiamo accesso non privilegiato e copiare l'output in un file
4. Eseguire il tool passandogli come argomento il database aggiornato e l'output di systeminfo: **./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt**

<figure><img src="../../.gitbook/assets/image (821).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (822).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (823).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (824).png" alt=""><figcaption></figcaption></figure>

```
sessions
sessions 3
getuid
shell
systeminfo
//copiamo il contenuto in un file, ad esempio aprendo un nuovo terminale ed eseguendo:
    cd Desktop
    vim win7.txt
    //incolla il contenuto
    :wq
    cd Windows-Enum/Windows-Exploit-Suggester //cartella dove abbiamo clonato il tool
    ./windows-exploit-suggester.py --update
    ./windows-exploit-suggester.py --database 2021-12-26.mssb.xls --system info /Desktop/win7.tzt

```

<figure><img src="../../.gitbook/assets/image (825).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (826).png" alt=""><figcaption></figcaption></figure>

L'intero output del comando deve essere copiato in un txt, da questo e in particolare dalla versione di windows e dagli hotfix (patch) installate il nostro tool sarà in grado di capire a cosa è vulnerabile il target.

<figure><img src="../../.gitbook/assets/image (827).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (828).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (831).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (830).png" alt=""><figcaption></figcaption></figure>

Ci viene presentata una lunga lista di exploit compatibili, quelli più in alto son quelli che è più probabile abbiano successo.

La prima che vediamo è la MS16-135 che ci dice essere una vulnerabilitù su Windows Kernel-;ode Drivers:

<figure><img src="../../.gitbook/assets/image (832).png" alt=""><figcaption></figcaption></figure>

E ci linka degli script disponibili su exploit-db e un repo github con maggiori info sulla CVE.

In particolare il secondo link a exploit-db è per un exploit che ci consente di fare privilege escalation:

<figure><img src="../../.gitbook/assets/image (833).png" alt=""><figcaption></figcaption></figure>

Cerchiamo maggior info su Google riguardo la vulnerabilità MS16-135:

<figure><img src="../../.gitbook/assets/image (834).png" alt=""><figcaption></figcaption></figure>

Troviamo questa pagina GitHub di SecWiki che contiene tutti i vari windows-kernel-exploits, cib abcge le relative CSV e MS ID:

<figure><img src="../../.gitbook/assets/image (835).png" alt=""><figcaption></figcaption></figure>

E cerchiamo quella che interessa a noi:

<figure><img src="../../.gitbook/assets/image (836).png" alt=""><figcaption></figcaption></figure>

Contiene poi il codice C che è interessante per comprendere cosa effettivamente fa questo exploit (e che non faccia nulla di malevolo, per quello ci consiglia questo repo github):

<figure><img src="../../.gitbook/assets/image (837).png" alt=""><figcaption></figcaption></figure>

Potremmo ora compilare questo exploit noi per poterlo usare, ma non lo vediamo in questo corso perché lo vedremo in un corso apposito relativo a buffer overflow e creare i nostri exploit.

Ma noi quindi in questo caso prendiamo il compilato già fornito sul github:

<figure><img src="../../.gitbook/assets/image (838).png" alt=""><figcaption></figcaption></figure>

Nel readme viene spiegato come usare l'exploit exe, e con quali versioni di windows è compatibile:

<figure><img src="../../.gitbook/assets/image (839).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (840).png" alt=""><figcaption></figcaption></figure>

### Utilizzare l'exploit con il binario precompilato (exe)

<figure><img src="../../.gitbook/assets/image (841).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (842).png" alt=""><figcaption></figcaption></figure>

Una volta scaricato dovrei trasferirlo sul target, eseguirlo e a quel punto avrei privilegi amministrativi.

<figure><img src="../../.gitbook/assets/image (843).png" alt=""><figcaption></figcaption></figure>

Ovviamente ci sarebbe nei casi reali da tenere conto dell'antivirus, ma questo lo vedremo in un corso apposito sull'antivirus bypass detection.

#### Carichiamo il file exe sul target

Nella cartella temporanea di windows, utilizzando la meterpreter shell che avevamo aperto (la session 3)

```
cd C:\\
ls
cd Temp\\
ls
upload /Downloads/41015.exe
shell
dir
.\41015.exe
.\41015.exe 7
whami
```

<figure><img src="../../.gitbook/assets/image (844).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (845).png" alt=""><figcaption></figcaption></figure>

Sempre meglio trasferire i file in cartelle temp sia in Windows che Linux. Perché sono poco accedute e monitorate dagli utenti.

<figure><img src="../../.gitbook/assets/image (846).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (847).png" alt=""><figcaption></figcaption></figure>

Eseguendolo ci mostra le versioni supportate e gli argomenti da usare a seconda del sistema target.

<figure><img src="../../.gitbook/assets/image (848).png" alt=""><figcaption></figcaption></figure>

ATTENZIONE: Non usare kernel exploit in ambienti di produzione prima di averne testato la stabilità con un ambiente di laboratorio come fatto qui.
