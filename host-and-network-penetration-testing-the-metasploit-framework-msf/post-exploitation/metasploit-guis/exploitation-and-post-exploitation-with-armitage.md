# Exploitation & Post Exploitation With Armitage



## Exploiting Victim 1

<figure><img src="../../../.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1225).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1226).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1228).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1229).png" alt=""><figcaption></figcaption></figure>

Possiamo fare dump degli hash con il secondo metodo (non lsass perché falliva):

<figure><img src="../../../.gitbook/assets/image (1230).png" alt=""><figcaption></figcaption></figure>

E otteniamo l'hash per administrator

Se poi clicchiamo su View > Loot possiamo vedere gli hash salvati:

<figure><img src="../../../.gitbook/assets/image (1231).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1232).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1233).png" alt=""><figcaption></figcaption></figure>

è possibile usando "Persist" fare persistenza utilizzando il Windows Registry:

<figure><img src="../../../.gitbook/assets/image (1234).png" alt=""><figcaption></figcaption></figure>

Oppure potremmo farlo manualmente cercando persistence\_service module:

<figure><img src="../../../.gitbook/assets/image (1235).png" alt=""><figcaption></figcaption></figure>

Comunque in questo caso non lo faremo perché è out of scope.

<figure><img src="../../../.gitbook/assets/image (1236).png" alt=""><figcaption></figcaption></figure>

Se clicchiamo su Post Modules ci elenca tutti i post exploitation modules che possiamo usare:

<figure><img src="../../../.gitbook/assets/image (1237).png" alt=""><figcaption></figcaption></figure>

Possiamo anche vedere graficament eil file system e le varie directory:

<figure><img src="../../../.gitbook/assets/image (1238).png" alt=""><figcaption></figcaption></figure>

E possiamo anche fare upload, creare una directory o listare tutti i vari drives (dischi), in questo caso c'è solo C:

<figure><img src="../../../.gitbook/assets/image (1239).png" alt=""><figcaption></figcaption></figure>

Dal file system posso anche modificare alcuni valori come ad esempio il timestamp di un file, oltre a scaricare, eseguire e visualizzare il file, e cancellarlo.

Show processes:

<figure><img src="../../../.gitbook/assets/image (1240).png" alt=""><figcaption></figcaption></figure>

E possiamo anche fare steal del token, inject o kill the process.

Possiamo fare e visualizzare gli screenshot:

<figure><img src="../../../.gitbook/assets/image (1241).png" alt=""><figcaption></figcaption></figure>

Possiamo anche cliccare su View > Downloads per vedere tutti i file scaricati sul nostro sistema dal target:

<figure><img src="../../../.gitbook/assets/image (1243).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1242).png" alt=""><figcaption></figcaption></figure>















## Pivoting to Victim 2

Se utilizziamo l'opzione Pivoting > Setup..., viene impostata automaticamente la subnet e la network mask.

<figure><img src="../../../.gitbook/assets/image (1244).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1245).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1246).png" alt=""><figcaption></figcaption></figure>

Sembra ci sia stato un errore, forse dobbiamo migrare a un processo a 64 bit. Riproviamo però prima di farlo:

<figure><img src="../../../.gitbook/assets/image (1247).png" alt=""><figcaption></figcaption></figure>

Quindi pare abbia già creato la route al posto nostro (quella da settare con autoroute).

### Aggiungere il secondo host vittima

Ora possiamo fare Hosts > Add Host e aggiungere l'IP della seconda vittima, che ora dovremmo riuscire a raggiungere se il pivoting ha funzionato.

<figure><img src="../../../.gitbook/assets/image (1248).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1249).png" alt=""><figcaption></figcaption></figure>

Host aggiunto, ma non ci sono info ancora quindi facciamo un Quick Scan con il tasto destro e vediamo se funziona e cosa trova.

<figure><img src="../../../.gitbook/assets/image (1250).png" alt=""><figcaption></figcaption></figure>

Impostiamo una Label con tasto dx > Host > Set Label...

<figure><img src="../../../.gitbook/assets/image (1251).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1252).png" alt=""><figcaption></figcaption></figure>

### Enumeration e Vulnerability Assessment su Victim-2

Facciamo un postcan/tcp sul Victim-2 per identificare i servizi, in particolare la porta 80 ci interessa.

<figure><img src="../../../.gitbook/assets/image (1253).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1255).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1254).png" alt=""><figcaption></figcaption></figure>

Per poter fare l'nmap scan e avere i dettagli del servizio alla porta 80 dobbiamo fare sulla Victim-1 che fa da ponte un port forwarding con il comando:

```
//Meterpreter Session su Victim-1
portfwd add -l 1234 -p 80 -r 10.5.28.140 
// l'ip è Victim-2, la porta 1234 è quella locale di Victim-1 su cui viene fatto il forwarding della porta 80 di Vctim-2

//Console MSF (non ho capito se è connessa in locale o su Victim-1):
db_nmap -sV -p 1234 localhost
```

<figure><img src="../../../.gitbook/assets/image (1256).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1257).png" alt=""><figcaption></figcaption></figure>

Il risultato è che viene aggiunto localhost alla mappa degli host perché abbiamo fatto lo scan su di lui, e viene trovato BadBlue in esecuzione sulla porta 1234, che è la 80 di Victim-2 in realtà.

Quindi ora exploitiamo BadBlue su Victim-2.

### Exploit di Victim-2 via BadBlue

<figure><img src="../../../.gitbook/assets/image (1258).png" alt=""><figcaption></figcaption></figure>

Possiamo rimuovere localhost cliccando con tasto DX > Host > Remove Host.

Cerchiamo l'exploit per BadBlue: badblue\_passthru.

<figure><img src="../../../.gitbook/assets/image (1259).png" alt=""><figcaption></figcaption></figure>

Impostiamo come RHOSTS l'IP di Victim-2, lanciamo l'exploit e riusciamo a exploitare anche Victim-2.

<figure><img src="../../../.gitbook/assets/image (1260).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1261).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (1262).png" alt=""><figcaption></figcaption></figure>

Abbiamo aperto una sessione Meterpreter sotto la sezione "Interact" del menù contestuale (tasto DX)

E riusciamo anche a fare Privilege Escalation tramite il comando getsystem.

<figure><img src="../../../.gitbook/assets/image (1263).png" alt=""><figcaption></figcaption></figure>

Ora possiamo fare varie operazioni, come hashdump ma non ce lo consente perché serve avere una sessione meterpreter su un processo a 64 bit, quindi facciamo la migrazione guardando i processi e individuando explorer.exe. Ma facciamo prima a farlo a mano invece che UI:

<figure><img src="../../../.gitbook/assets/image (1264).png" alt=""><figcaption></figcaption></figure>

Riproviamo ora a prendere gli hash con il metodo wdigest:

<figure><img src="../../../.gitbook/assets/image (1265).png" alt=""><figcaption></figcaption></figure>

Ed otteniamo un po' di errori. Quindi riproviamo con il metodo lsass, ed otteniamo gli hash:

<figure><img src="../../../.gitbook/assets/image (1266).png" alt=""><figcaption></figcaption></figure>
